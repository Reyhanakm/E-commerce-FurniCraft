{% extends "admin/base_admin.html" %}
{% block title %}Order {{ order.order_id }} - Details{% endblock %}

{% block content %}

<div class="mb-6">
    <h1 class="text-2xl font-semibold text-gray-800">
        Order Details – {{ order.order_id }}
    </h1>
</div>


<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">Order Information</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        <div>
            <p><span class="font-medium">Customer:</span> 
               {{ order.user.first_name }} {{ order.user.last_name }}</p>

            <p><span class="font-medium">Email:</span> {{ order.user.email }}</p>

            <p><span class="font-medium">Payment Method:</span> 
                {{ order.get_payment_method_display }}
            </p>            
            <p><span class="font-medium">Payment Status:</span>
                {% if order.payment_status == "paid" %}
                    <span class="text-green-600 font-semibold">Paid</span>
                {% elif order.payment_status == "pending" %}
                    <span class="text-yellow-600 font-semibold">Pending</span>
                {% elif order.payment_status == "refunded" %}
                    <span class="text-blue-600 font-semibold">Refunded</span>
                {% elif order.payment_status == "partially_refunded" %}
                    <span class="text-orange-600 font-semibold">Partially refunded</span>
                {% else %}
                    <span class="text-red-600 font-semibold">Failed</span>
                {% endif %}
            </p>
          
            <form method="POST">
            {% csrf_token %}
            <select name="payment_status" class="border rounded px-2 py-1">
                <option value="pending" {% if order.payment_status == "pending" %}selected{% endif %}>Pending</option>
                <option value="paid" {% if order.payment_status == "paid" %}selected{% endif %}>Paid</option>
                <option value="refunded" {% if order.payment_status == "refunded" %}selected{% endif %}>Refunded</option>
                <option value="partially_refunded" {% if order.payment_status == "partially_refunded" %}selected{% endif %}>Partially Refunded</option>
                <option value="failed" {% if order.payment_status == "failed" %}selected{% endif %}>Failed</option>
            </select>

            <button class="bg-[#b82d2d] text-white px-3 py-1 rounded hover:bg-[#a22727] transition">Update</button>
            </form>

            <p><span class="font-medium">Order Date:</span> 
                {{ order.created_at|date:"d M Y, h:i A" }}
            </p>
        </div>

        <div>
            <p class="font-medium mb-1">Delivery Address:</p>
            <div class="p-3 border rounded-md bg-gray-50">
                <p>{{ order.address.name }}</p>
                <p>{{ order.address.phone_no }}</p>
                <p>{{ order.address.street }}</p>
                <p>{{ order.address.district }}, {{ order.address.state }}</p>
                <p>{{ order.address.pincode }}</p>
            </div>

            <p class="mt-4">
                <span class="font-medium">Total Amount:</span>
                {% if order.total_price %}
                    ₹{{ order.total_price }}
                {% else %}
                    ₹{{ order.total_price_before_discount }}
                {% endif %}
            </p>
        </div>

    </div>
</div>

<!-- ORDER ITEMS TABLE -->
<div class="bg-white shadow rounded-lg overflow-hidden">
    <h2 class="px-6 py-4 border-b font-semibold text-gray-700 text-lg">
        Items in Order
    </h2>

    <table class="min-w-full text-left">
        <thead class="bg-gray-100 text-gray-700">
            <tr>
                <th class="px-6 py-3">Product</th>
                <th class="px-6 py-3">Qty</th>
                <th class="px-6 py-3">Unit Price</th>
                <th class="px-6 py-3">Total</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3 text-center">Actions</th>
            </tr>
        </thead>

        <tbody class="text-gray-700">
            {% for item in items %}
            <tr class="border-b">

    <!-- PRODUCT -->
    <td class="px-6 py-4">
        {{ item.product.product.name }} — ({{ item.product.material_type }})
    </td>

    <!-- QTY -->
    <td class="px-6 py-4">
        {{ item.quantity }}
    </td>

    <!-- UNIT PRICE -->
    <td class="px-6 py-4">
        ₹{{ item.unit_price }}
    </td>

    <!-- TOTAL -->
    <td class="px-6 py-4">
        ₹{{ item.price }}
    </td>

    <!-- STATUS -->
    <td class="px-6 py-4 font-bold">
        {{ item.get_status_display }}
    </td>

    <!-- ACTIONS (EVERYTHING GOES INSIDE THIS TD) -->
    <td class="px-6 py-4 text-center">

        <div class="flex flex-col items-center gap-2">

            <!-- STATUS UPDATE FORM -->
            <form method="POST" class="flex gap-2">
                {% csrf_token %}
                <input type="hidden" name="item_id" value="{{ item.id }}">

                <select name="status" class="border rounded px-2 py-1">
                    {% for value,label in item.STATUS_CHOICES %}
                        {% if value not in "cancelled returned" %}
                            <option value="{{ value }}"
                                {% if value == item.status %}selected{% endif %}
                            >
                                {{ label }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>

                <button
                    class="bg-[#b82d2d] text-white px-3 py-1 rounded hover:bg-[#a22727]">
                    Update
                </button>
            </form>

            <!-- RETURN MANAGEMENT -->
            {% with return_request=item.return_items.first %}
                {% if return_request %}
                    {% if return_request.approval_status == "pending" %}
                        <a href="{% url 'admin_return_list' %}"
                           class="text-sm text-blue-600 hover:underline">
                            Manage Return
                        </a>
                    {% else %}
                        <span class="text-sm font-semibold text-gray-600">
                            Return {{ return_request.approval_status|capfirst }}
                        </span>
                    {% endif %}
                {% endif %}
            {% endwith %}

        </div>

    </td>
</tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
