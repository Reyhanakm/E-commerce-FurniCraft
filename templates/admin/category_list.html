{% extends "admin/base_admin.html" %}
{% load custom_tags %}
{% block title %}Categories - FurniCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-semibold text-gray-800">Categories</h1>

  <!-- Search + Add Button -->
  <div class="flex items-center gap-3">
    <form method="get" class="flex items-center gap-3">
      <div class="relative">
        <input 
          type="text" 
          name="q" 
          placeholder="Search" 
          value="{{ search_query }}"
          class="pl-10 pr-4 py-2 border rounded-md focus:ring focus:ring-gray-200"
        />
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 absolute left-3 top-2.5 text-gray-400"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
        </svg>
        {% if search_query %}
          <a href="{% url 'admin_category_list' %}"
             class="absolute right-3 top-2 text-gray-400 hover:text-red-500 font-bold">✕</a>
        {% endif %}
      </div>
      <button type="submit" class="bg-[#b82d2d] text-white px-4 py-2 rounded-md">Search</button>
    </form>
{% comment %} 
    <button id="openAddModal" class="bg-[#b82d2d] text-white px-4 py-2 rounded-md hover:bg-[#a22727] transition">
      + Add Category
    </button> {% endcomment %}
     <a href="{% url 'add_category' %}"
       class="bg-[#b82d2d] text-white px-4 py-2 rounded-md hover:bg-[#a22727] transition">
      + Add Category
    </a> 
    
  </div>
</div>

<!-- Category Table -->
<div class="bg-white shadow-sm rounded-md overflow-hidden">
  <table class="min-w-full text-left border-collapse">
    <thead>
      <tr class="bg-[#b82d2d] text-white">
        <th class="px-4 py-2">S.No</th>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Image</th>
        <th class="px-4 py-2">Deleted</th>
        <th class="px-4 py-2">Created At</th>
        <th class="px-4 py-2 text-center">Actions</th>
      </tr>
    </thead>
    <tbody class="text-gray-700">
      {% for cat in page_obj %}
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-3">{{ forloop.counter0|add:page_obj.start_index  }}</td>
        <td class="px-4 py-3">{{ cat.name }}</td>
        {% comment %} <td class="px-4 py-3 w-14 h-14 object-cover rounded-md cursor-pointer"
        >{{cat.image}}</td> {% endcomment %}
        <td class="px-4 py-3">
        {% if primary_images|get_item:cat.id %}
              <img src="{{ primary_images|get_item:cat.id }}" alt="{{ cat.name }}"
              class="w-14 h-14 object-cover rounded-md border hover:scale-105 transition-transform duration-200 cursor-pointer"
              >
              {% comment %} onclick="openImageModal('{{ primary_images.pdt.id }}')" {% endcomment %}
        {% else %}
      <div class="w-14 h-14 bg-gray-100 flex items-center justify-center text-gray-400 text-sm border rounded-md">
        N/A
      </div>
    {% endif %}
  </td> 
        <td class="px-4 py-3">
          {% if cat.is_deleted %}
            <span class="text-red-600 font-medium">Deleted</span>
          {% else %}
            <span class="text-green-600 font-medium">Active</span>
          {% endif %}
        </td>
        <td class="px-4 py-3">{{ cat.created_at|date:"Y-m-d H:i" }}</td>
        <td class="px-4 py-3 text-center">

          {% if cat.is_deleted %}
  <button type="button"
          onclick="confirmRestore('{% url 'restore_category' cat.id %}', '{{ cat.name }}')"
          class="text-green-600 hover:text-green-800 font-medium">
    Restore
  </button>
{% else %}
  {% comment %} <button type="button"
          onclick="openModal('Edit Category', {{ cat.id }}, '{{ cat.name }}', {{ cat.is_deleted|yesno:'true,false' }})"
          class="text-blue-600 hover:text-blue-800 font-medium mr-2">
    Edit
  </button> {% endcomment %}
  <a href="{% url 'edit_category' cat.id %}"
   class="text-blue-600 hover:text-blue-800 font-medium mr-2">
   Edit
  </a>

  <button type="button"
          onclick="confirmDelete('{% url 'delete_category' cat.id %}', '{{ cat.name }}')"
          class="text-red-600 hover:text-red-800 font-medium">
    Delete
  </button>
{% endif %}

          {% comment %} <button type="button"
          onclick="openModal('Edit Category', {{ cat.id }}, '{{ cat.name }}', {{ cat.is_deleted|yesno:'true,false' }})"
          class="text-blue-600 hover:text-blue-800 font-medium mr-2">
          Edit
        </button>
          <button 
             onclick="confirmDelete('{% url 'delete_category' cat.id %}', '{{ cat.name }}')" 
             class="text-red-600 hover:text-red-800 font-medium">
             Delete
          </button> {% endcomment %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center py-6 text-gray-500">No categories found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="categoryModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-96">
    <h2 id="modalTitle" class="text-lg font-semibold mb-4">Add Category</h2>
    <form id="categoryForm">
      {% csrf_token %}
      <input type="hidden" id="catId" name="id">
      
      <label class="block text-gray-700 mb-2">Name</label>
      <input type="text" name="name" id="catName"
             class="w-full border px-3 py-2 rounded-md focus:ring focus:ring-gray-200 mb-4" required>

      <div id="isDeletedField" class="hidden mb-4">
        <label class="inline-flex items-center">
          <input type="checkbox" id="catDeleted" name="is_deleted" class="mr-2">
          Mark as Deleted
        </label>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-[#b82d2d] text-white rounded-md hover:bg-[#a22727]">Save</button>
      </div>
    </form>
  </div>
</div>
{% include 'pagination.html'%}
{% endblock %}

{% block extra_scripts %}
<script>
  const modal = document.getElementById("categoryModal");
  const openBtn = document.getElementById("openAddModal");
  const cancelBtn = document.getElementById("cancelModal");
  const form = document.getElementById("categoryForm");

  // Open modal
  function openModal(title, id = null, name = '', isDeleted = false) {
    document.getElementById("modalTitle").textContent = title;
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");

    if (id) {
      document.getElementById("catId").value = id;
      document.getElementById("catName").value = name;
      document.getElementById("isDeletedField").classList.remove("hidden");
      document.getElementById("catDeleted").checked = isDeleted;
    } else {
      form.reset();
      document.getElementById("catId").value = "";
      document.getElementById("isDeletedField").classList.add("hidden");
    }
  }

  openBtn.addEventListener("click", () => openModal("Add Category"));
  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  });

  function confirmRestore(url, name) {
  confirmAction(`Restore category "${name}"?`, "Yes, Restore", () => {
    fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRFToken() },
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast("✅ Category restored successfully", "success");
          setTimeout(() => location.reload(), 800);
        } else {
          showToast(data.message || "⚠️ Restore failed", "error");
        }
      })
      .catch(() => showToast("❌ Network error", "error"));
  });
}


  // Handle form submit via AJAX
  form.addEventListener("submit", e => {
    e.preventDefault();
    const formData = new FormData(form);
    const id = formData.get("id");
    const url = id 
      ? `/admin/categories/edit/${id}/`
      : `/admin/categories/add/`;

    fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRFToken() },
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("✅ Category saved successfully", "success");
        modal.classList.add("hidden");
        setTimeout(() => location.reload(), 800);
      } else {
        showToast("⚠️ Failed to save category", "error");
      }
    });
  });

  // Delete confirmation using SweetAlert (already available in base_admin)
  function confirmDelete(url, name) {
    confirmAction(`Delete "${name}"?`, "Yes, Delete", () => {
      window.location.href = url;
    });
  }
</script>
{% endblock %}
