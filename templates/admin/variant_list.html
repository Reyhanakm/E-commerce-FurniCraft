{% extends 'admin/base_admin.html' %}

{% block title %}Variants - FurniCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-2xl font-semibold text-gray-800">Variant Management</h1>
    <p class="text-gray-500 text-sm mt-1">For Product: 
      <span class="font-medium text-gray-800"><a href="{% url 'admin_product_list' %}">{{ product.name }}</a></span>
    </p>
  </div>

  <!-- Search + Filter -->
  <form method="get" class="flex items-center gap-3">
    <div class="relative">
      <input type="text" name="q" value="{{ search_query }}" placeholder="Search Variants..."
             class="pl-10 pr-4 py-2 border rounded-md focus:ring focus:ring-gray-200 w-64" />
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 absolute left-3 top-2.5 text-gray-400"
           fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
      </svg>

      {% if search_query %}
        <a href="{% url 'admin_variant_list' product.id %}"
           class="absolute right-3 top-2 text-gray-400 hover:text-red-500 font-bold">✕</a>
      {% endif %}
    </div>

    <!-- Filter dropdown -->
    <select name="filter" class="border rounded-md px-3 py-2 bg-white text-gray-700">
      <option value="">All</option>
      <option value="active" {% if filter_status == 'active' %}selected{% endif %}>Active</option>
      <option value="deleted" {% if filter_status == 'deleted' %}selected{% endif %}>Deleted</option>
    </select>

    <button type="submit" class="bg-[#b82d2d] text-white px-4 py-2 rounded-md hover:bg-[#a22727]">
      Apply
    </button>
  </form>
</div>

<!-- Add Variant Button -->
<div class="mb-5">
  <a href="{% url 'add_variant' product.id %}" 
     class="bg-[#b82d2d] text-white px-4 py-2 rounded-md hover:bg-[#a22727] transition-all duration-200">
     + Add New Variant
  </a>
</div>


<!-- Table -->
<div class="bg-white shadow-sm rounded-md overflow-hidden">
  <table class="min-w-full text-left border-collapse">
    <thead>
  <tr class="bg-[#b82d2d] text-white">
    <th class="px-4 py-2">S.No</th>
    <th class="px-4 py-2">Material Type</th>
    {% comment %} <th class="px-4 py-2">Description</th> {% endcomment %}
    <th class="px-4 py-2">Regular Price</th>
    <th class="px-4 py-2">Sales Price</th>
    <th class="px-4 py-2">Stock</th>
    <th class="px-4 py-2">Status</th>
    <th class="px-4 py-2">Actions</th>
  </tr>
</thead>

<tbody class="text-gray-700">
  {% for variant in variants %}
  <tr class="border-b hover:bg-gray-50">
    <td class="px-4 py-3">{{ forloop.counter }}</td>
    <td class="px-4 py-3 font-medium">{{ variant.material_type }}</td>
    {% comment %} <td class="px-4 py-3 text-sm text-gray-600">{{ variant.description|default:"—" }}</td> {% endcomment %}
    <td class="px-4 py-3">₹{{ variant.regular_price }}</td>
    <td class="px-4 py-3">₹{{ variant.sales_price }}</td>
    <td class="px-4 py-3">{{ variant.stock }}</td>
    <td class="px-4 py-3">
      {% if variant.is_deleted %}
        <span class="bg-gray-200 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full">Deleted</span>
      {% else %}
        <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-1 rounded-full">Active</span>
      {% endif %}
    </td>
    <td class="px-4 py-3 space-x-2">
      {% if variant.is_deleted %}
        <button type="button"
                onclick="confirmRestore('{% url 'restore_variant' variant.id %}', '{{ variant.material_type }}')"
                class="text-green-600 hover:text-green-800 font-medium">
          Restore
        </button>
      {% else %}
        <a href="{% url 'edit_variant' variant.id %}" 
           class="text-blue-600 hover:text-blue-800 font-medium">Edit</a>
        <span>|</span>
        <a href="{% url 'delete_variant' variant.id %}" 
           onclick="confirmDelete('{{ variant.id }}', '{{ variant.material_type }}'); return false;"
           class="text-red-600 hover:text-red-800 font-medium">
           Delete
        </a>
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="8" class="text-center py-6 text-gray-500">No variants found.</td>
  </tr>
  {% endfor %}
</tbody>
</table>
</div>

<!-- Pagination -->
<div class="flex justify-center items-center mt-6 space-x-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if filter_status %}&filter={{ filter_status }}{% endif %}"
       class="px-3 py-1 border rounded-md text-gray-500 hover:bg-gray-100">‹</a>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
      <span class="px-3 py-1 border rounded-md bg-gray-200">{{ num }}</span>
    {% else %}
      <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if filter_status %}&filter={{ filter_status }}{% endif %}"
         class="px-3 py-1 border rounded-md hover:bg-gray-100">{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if filter_status %}&filter={{ filter_status }}{% endif %}"
       class="px-3 py-1 border rounded-md text-gray-500 hover:bg-gray-100">›</a>
  {% endif %}
</div>

<!-- SweetAlert Delete & Restore -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmDelete(variantId, variantName) {
  Swal.fire({
    title: `Delete ${variantName}?`,
    text: "This action cannot be undone.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, delete it!"
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = `/admin/variants/delete/${variantId}/`;
    }
  });
}

function confirmRestore(url, name) {
  Swal.fire({
    title: `Restore ${name}?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonColor: "#28a745",
    cancelButtonColor: "#6c757d",
    confirmButtonText: "Yes, Restore"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCSRFToken() },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          Swal.fire("Restored!", `${name} has been restored.`, "success");
          setTimeout(() => location.reload(), 800);
        } else {
          Swal.fire("Error", data.message || "Restore failed", "error");
        }
      })
      .catch(() => Swal.fire("Error", "Network error", "error"));
    }
  });
}
</script>
{% endblock %}
