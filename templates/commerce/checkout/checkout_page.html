{% extends "product/navbar_footer.html" %}
{% load product_filters %}
{% block content %}

<div class="max-w-6xl mx-auto py-10 px-4 grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- LEFT SIDE -->
    <div class="md:col-span-2 space-y-6">

        <!-- SINGLE CHECKOUT FORM  -->
        <form action="{% url 'place_order' %}" method="POST">
            {% csrf_token %}

            <!-- ADDRESS SECTION -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Delivery Address</h2>
                <div id="address-container" class="space-y-4">
                {% if has_address %}
                        {% for address in addresses %}
                        <label class="flex gap-3 items-start border rounded-lg p-4 cursor-pointer">
                            <input
                                type="radio"
                                name="address"
                                value="{{ address.id }}"
                                {% if address.is_default %}checked{% endif %}
                                required
                            >
                            <div>
                                <p class="font-semibold">{{ address.name }}</p>
                                <p class="text-sm text-gray-600">{{ address.phone_no }}</p>
                                <p class="text-sm text-gray-600">
                                    {{ address.house }}, {{ address.street }},
                                    {{ address.district }}, {{ address.state }} - {{ address.pincode }}
                                </p>
                            </div>
                        </label>
                        {% endfor %}
                {% else %}
                    <p class="text-red-600 font-medium">
                        ⚠ Please add an address to continue checkout.
                    </p>
                {% endif %}
                </div>

                <!-- Add Address Button -->
                <button
                    type="button"
                    hx-get="{% url 'add_address' %}?from=checkout"
                    hx-target="#address-container"
                    hx-swap="innerHTML"
                    class="mt-4 text-[#A89289] font-medium">
                    + Add New Address
                </button>
            </div>


            <!-- PAYMENT METHOD -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Payment Method</h2>

                <div class="space-y-3">
                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="wallet" required>
                        Wallet
                    </label>
                      <span class="text-sm text-gray-600">Pay using Wallet (Balance: ₹{{ request.user.wallet.balance }})</span>


                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="razorpay" required checked>
                        RazorPay
                    </label>
                        <div id="cod-section">
                    <label class="flex items-center gap-3">
                        <input type="radio" name="payment_method" value="cod"{% if not cod_allowed %}disabled{% endif %} >
                       <span {% if not cod_allowed %}class="text-gray-400"{% endif %} >Cash On Delivery</span> 
                    </label>
                    {% if not cod_allowed %}
                    <p class="text-sm text-red-500 mt-1">
                        Cash on Delivery is available only for orders up to ₹1000.
                    </p>
                    {% endif %}
                </div>
                </div>
            </div>

            <!-- PLACE ORDER BUTTON -->
            <button
                id="place-order-btn" 
                type="button"
                class="mt-6 w-full bg-[#A89289] text-white font-semibold py-3 rounded-lg
                    {% if not has_address %}opacity-50 cursor-not-allowed{% endif %}"
                onclick="confirmPlaceOrder()"
                {% if not has_address %}disabled{% endif %}
            >
                Place Order
            </button>

        </form>

        <!-- ADD ADDRESS FORM -->
        <div id="add-address"></div>

    </div>

    <!-- RIGHT SIDE: ORDER SUMMARY -->
    <div class="space-y-6">

        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Order Summary</h2>

            {% for item in products %}
            <div class="flex justify-between py-3 border-b">
                <div class="flex gap-3">
                    {% with primary_image=item.product.images.all|get_primary_image %}
                            {% if primary_image %}
                                <img src="{{ primary_image.image.url }}" class="w-16 h-16 object-cover border rounded-md">
                            {% else %}
                                <div class="w-16 h-16 bg-gray-100 flex items-center justify-center 
                                            text-gray-400 text-xs border rounded-md">
                                    No Image
                                </div>
                            {% endif %}
                            {% endwith %}

                    <div>
                        <p class="font-medium">{{ item.product.name }}</p>
                        <p class="text-sm text-gray-600">{{ item.variant.material_type }}</p>
                        <p class="text-sm">Qty: {{ item.quantity }}</p>
                    </div>
                </div>

                {% if item.offer_percent > 0 %}
                    <div class="text-right">
                        <p class="font-semibold text-[#A89289]">
                            ₹{{ item.discounted_price|floatformat:2 }}
                        </p>
                        <p class="text-sm text-gray-400 line-through">
                            ₹{{ item.variant.sales_price|floatformat:2 }}
                        </p>
                        <p class="text-xs text-green-600">
                            {{ item.offer_percent }}% OFF applied
                        </p>
                    </div>
                {% else %}
                    <p class="font-semibold">₹{{ item.variant.sales_price|floatformat:2 }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div id="coupon-section">
            {% include "commerce/checkout/_coupon_totals.html" %}
        </div>       
       

    </div>
</div>
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === "address-container") {
            const hasAddress = document.querySelector('input[name="address"]');
            const btn = document.getElementById("place-order-btn");

            if (hasAddress && btn) {
                btn.disabled = false;
                btn.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }
    });
function confirmPlaceOrder() {
    const selectedAddress = document.querySelector('input[name="address"]:checked');
    if (!selectedAddress) {
        alert("Please select a delivery address.");
        return; 
    }

    const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
    if (!paymentMethod) {
        alert("Please select a payment method");
        return;
    }

    let message = "Are you sure you want to place this order?";
    let confirmText = "Place Order";
    let color = "#2563eb";

    if (paymentMethod === "razorpay") {
        message = "You will be redirected to Razorpay to complete the payment. Continue?";
        confirmText = "Pay Now";
    } 
    else if (paymentMethod === "wallet") {
        message = "Wallet balance will be used to place this order. Continue?";
        confirmText = "Pay with Wallet";
        color = "#16a34a";
    } 
    else if (paymentMethod === "cod") {
        message = "You will pay in cash when the order is delivered. Continue?";
        confirmText = "Confirm Order";
        color = "#ca8a04";
    }

    confirmAction(
        message,
        confirmText,
        () => document.querySelector("form").submit(),
        color
    );
}
</script>
{% endblock %}

